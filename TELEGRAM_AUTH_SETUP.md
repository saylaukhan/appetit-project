# Настройка авторизации через Telegram

Этот документ описывает, как настроить авторизацию через Telegram в проекте APPETIT.

## Обзор функциональности

Система авторизации через Telegram позволяет пользователям:
- Войти в систему, используя номер телефона, привязанный к Telegram
- Получить код подтверждения прямо в Telegram
- Автоматически зарегистрироваться при первом входе
- Избежать необходимости запоминать пароли

## Настройка Telegram API

### 1. Получение API ID и API Hash

1. Перейдите на https://my.telegram.org/
2. Войдите в свой аккаунт Telegram
3. Перейдите в раздел "API development tools"
4. Создайте новое приложение:
   - App title: `APPETIT Food Delivery`
   - Short name: `appetit`
   - URL: `https://appetit.kz` (или ваш домен)
   - Platform: `Web`
5. Получите `api_id` и `api_hash`

### 2. Создание Telegram бота (опционально)

Если вы хотите использовать бота для отправки уведомлений:

1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Получите токен бота

### 3. Настройка переменных окружения

Создайте файл `.env` в папке `backend/` на основе `.env.example`:

```env
# Telegram Settings
TELEGRAM_API_ID=your_api_id_here
TELEGRAM_API_HASH=your_api_hash_here
TELEGRAM_BOT_TOKEN=your_bot_token_here  # Опционально
TELEGRAM_ENABLED=true
```

## Установка зависимостей

### Backend

```bash
cd backend
pip install telethon==1.36.0
```

### Frontend

Зависимости уже включены в проект.

## Как это работает

### Процесс авторизации

1. **Запрос кода**: Пользователь вводит номер телефона
2. **Отправка кода**: Система отправляет код через Telegram API
3. **Подтверждение**: Пользователь вводит код из Telegram
4. **Авторизация**: Система создает JWT токен и авторизует пользователя

### Режим разработки

Когда `TELEGRAM_ENABLED=false`, система работает в режиме разработки:
- Генерируется фиктивный код
- Код отображается в консоли и в интерфейсе
- Не требуется настройка Telegram API

### Архитектура

```
Frontend (React)
├── TelegramAuth.jsx - Компонент авторизации
├── AuthContext.jsx - Контекст с методами
└── LoginPage.jsx - Страница входа

Backend (FastAPI)
├── telegram.py - Сервис Telegram API
├── auth.py - Сервис авторизации
└── endpoints/auth.py - API эндпоинты
```

## API Endpoints

### POST /api/v1/auth/telegram/request-code

Запрос кода подтверждения через Telegram.

**Запрос:**
```json
{
  "phone": "+77001234567"
}
```

**Ответ:**
```json
{
  "message": "Код отправлен через Telegram",
  "phone_code_hash": "hash_from_telegram_api",
  "dev_mode": false
}
```

### POST /api/v1/auth/telegram/verify

Подтверждение кода и авторизация.

**Запрос:**
```json
{
  "phone": "+77001234567",
  "code": "12345",
  "phone_code_hash": "hash_from_telegram_api",
  "name": "Имя пользователя"  // Только для новых пользователей
}
```

**Ответ:**
```json
{
  "access_token": "jwt_token",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "phone": "+77001234567",
    "name": "Имя пользователя",
    "role": "client",
    "is_active": true,
    "is_verified": true
  },
  "auth_method": "telegram"
}
```

## Безопасность

### Меры безопасности

1. **Валидация номера**: Проверка формата номера телефона
2. **Срок действия кода**: Коды действуют 10 минут
3. **Хеширование**: Используется phone_code_hash от Telegram
4. **JWT токены**: Безопасная авторизация после подтверждения
5. **Очистка данных**: Автоматическая очистка истекших кодов

### Рекомендации

1. Используйте HTTPS в прода��шене
2. Регулярно обновляйте зависимости
3. Мониторьте попытки авторизации
4. Настройте rate limiting для API

## Тестирование

### Режим разработки

```bash
# В backend/.env
TELEGRAM_ENABLED=false
```

В этом режиме:
- Коды генерируются локально
- Отображаются в консоли и UI
- Не требуется Telegram API

### Тестирование с реальным API

```bash
# В backend/.env
TELEGRAM_ENABLED=true
TELEGRAM_API_ID=your_real_api_id
TELEGRAM_API_HASH=your_real_api_hash
```

## Устранение неполадок

### Частые проблемы

1. **"Invalid API ID/Hash"**
   - Проверьте правильность API ID и Hash
   - Убедитесь, что они соответствуют вашему приложению

2. **"Phone number invalid"**
   - Используйте международный формат: +77001234567
   - Убедитесь, что номер привязан к Telegram

3. **"Flood wait"**
   - Слишком много запросов, подождите указанное время
   - Реализуйте rate limiting

4. **"Session password needed"**
   - У пользователя включена двухфакторная аутентификация
   - Требуется дополнительная реализация для 2FA

### Логи

Проверьте логи в `backend/logs/app.log` для диагностики проблем.

## Дополнительные возможности

### Будущие улучшения

1. **Поддержка 2FA**: Обработка двухфакторной аутентификации
2. **Telegram бот**: Интеграция с ботом для уведомлений
3. **Кеширование**: Redis для хранения сессий
4. **Аналитика**: Отслеживание методов авторизации

### Интеграция с другими сервисами

Система легко расширяется для поддержки:
- WhatsApp Business API
- SMS через другие провайдеры
- Email авторизация
- Social login (Google, Facebook)

## Поддержка

Если у вас возникли вопросы или проблемы:

1. Проверьте логи приложения
2. Убедитесь в правильности конфигурации
3. Протестируйте в режиме разработки
4. Обратитесь к документации Telegram API

---

**Примечание**: Этот функционал требует активного интернет-соединения и корректно настроенного Telegram API. В режиме разработки можно тестировать без реального API.